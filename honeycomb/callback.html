<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Honeycomb OAuth Token Exchange</title>
</head>
<body>
  <h1>OAuth Token Exchange Automation</h1>
  <p>The token exchange request to ui.honeycomb.io/oauth/token will be sent automatically if a code is in the URL; otherwise enter a code below and click the button.</p>

  <button id="send-btn" onclick="sendTokenRequest(false)">Send Token Request</button>

  <div id="manual-code-input" style="margin-top:12px; display:none;">
    <label for="manual-code">Enter Code Manually:</label>
    <input type="text" id="manual-code" placeholder="paste authorization code here" style="width: 600px;" />
    <button onclick="sendTokenRequest(true)">Use This Code</button>
  </div>

  <div id="token-display" style="margin-top: 16px; display: none;">
    <div><strong>Access Token:</strong></div>
    <div id="access-token" style="font-family: monospace; white-space: pre-wrap; word-break: break-all;"></div>
  </div>

  <script>
    // OAuth token exchange constants
    const tokenUrl = 'https://ui.honeycomb.io/oauth/token';
    const clientId = 'hcaoc_01k9ckyt8aq42x6s6h28p3kw55';
    const grantType = 'authorization_code';
    const codeVerifier = '6trgBvuwRy_U7FBzGT0e3NNj3J01AbDkub5h9V65Jgc';
    const clientSecret = 'nxk384hva53821kvbmg951eqmxdb373j';
    const redirectUri = 'https://nikhilkaushikop.github.io/postmessage/honeycomb/callback';

    function getCodeFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get('code') || '';
    }

    function getCodeFromHash() {
      const hash = window.location.hash ? window.location.hash.slice(1) : '';
      const params = new URLSearchParams(hash);
      return params.get('code') || '';
    }

    function detectedCode() {
      const q = getCodeFromQuery();
      if (q) return { code: q, source: 'query' };
      const h = getCodeFromHash();
      if (h) return { code: h, source: 'hash' };
      return { code: '', source: 'none' };
    }

    async function sendTokenRequest(preferManual) {
      const manualEl = document.getElementById('manual-code');
      const manual = manualEl ? (manualEl.value || '').trim() : '';
      const { code: fromUrl } = detectedCode();
      const code = preferManual ? (manual || fromUrl) : (fromUrl || manual);

      if (!code) {
        alert('No code found in URL or manual input. Please provide a code.');
        return;
      }

      const btn = document.getElementById('send-btn');
      btn.disabled = true;
      btn.textContent = 'Sending...';

      const body = new URLSearchParams({
        client_id: clientId,
        grant_type: grantType,
        code: code,
        code_verifier: codeVerifier,
        client_secret: clientSecret,
        redirect_uri: redirectUri
      });

      try {
        const resp = await fetch(tokenUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString()
        });

        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
        }

        const data = await resp.json();
        const token = data.access_token || 'No access_token in response';
        document.getElementById('access-token').textContent = token;
        document.getElementById('token-display').style.display = 'block';
      } catch (e) {
        alert('Error during token exchange: ' + e.message);
        console.error(e);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Send Token Request';
      }
    }

    window.onload = function () {
      const found = detectedCode();
      if (found.code) {
        sendTokenRequest(false);
      } else {
        document.getElementById('manual-code-input').style.display = 'block';
      }
    };
  </script>
</body>
</html>
