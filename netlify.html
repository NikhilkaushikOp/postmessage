<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login with Netlify</title>
    <script>
        // Function to extract the authorization code from the URL
        function getAuthorizationCodeFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code');
        }

        // Function to handle the login redirection to Netlify OAuth
        function loginWithNetlify() {
            // Redirect to Netlify OAuth authorization URL
            window.location.href = "https://app.netlify.com/authorize?client_id=GMS8wnRA7AfY1Cmhr3On-xvzXnGRKEHCe_dzGYln8Vw&response_type=token&state=eyJyZXNwb25zZV90eXBlIjoiY29kZSIsImNsaWVudF9pZCI6InJVbkhaSU9ycmsxS2lBVElEUHRDUnY2Rkd1VkhxWXpWMmpKR3VSaU84ZHIiLCJyZWRpcmVjdF91cmkiOiJodHRwczovL25pa2hpbGthdXNoaWtvcC5naXRodWIuaW8vcG9zdG1lc3NhYWdlL25ldGxpZnksInN0YXRlIjoiWDVTV0hpMXZzaXJaYW5oUnlUYTdmeXlUVmtMcVFSSFVNelk3a2hFbEJXVSIsInNjb3BlIjoib3BlbmlkIG9mZmxpbmVfYWNjZXNzIHJlYWQgd3JpdGUgY2xhdWRlYWkiLCJjb2RlX2NoYWxsZW5nZSI6ImQ2UkJtZngwcVJibHNOVUtpSEFuYVBHUVdyd2xiWlRsajc3TWtDajk2ZzgiLCJjb2RlX2NoYWxsZW5nZV9tZXRob2QiOiJTMjU2In0=&redirect_uri=https://netlify-mcp.netlify.app/oauth-server/client-redirect";
        }

        // Function to exchange authorization code for access token
        function getAccessToken(authorizationCode) {
            const data = new URLSearchParams();
            data.append("grant_type", "authorization_code");
            data.append("code", authorizationCode);
            data.append("redirect_uri", "https://claude.ai/api/mcp/auth_callback");
            data.append("client_id", "GMS8wnRA7AfY1Cmhr3On-xvzXnGRKEHCe_dzGYln8Vw");

            // Send POST request to get the access token
            fetch("https://netlify-mcp.netlify.app/oauth-server/token", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Accept": "application/json",
                },
                body: data.toString(),
            })
            .then(response => response.json())
            .then(data => {
                if (data.access_token) {
                    // Successfully received access token
                    document.getElementById("authorization-code").textContent = "Access Token: " + data.access_token;
                    // Now fetch user info using the access token
                    getUserInfo(data.access_token);
                } else {
                    document.getElementById("authorization-code").textContent = "Error: " + data.error_description;
                }
            })
            .catch(error => {
                document.getElementById("authorization-code").textContent = "Error: " + error;
            });
        }

        // Function to fetch user information using the access token
        function getUserInfo(accessToken) {
            const headers = {
                "Authorization": `Bearer ${accessToken}`,
                "Content-Type": "application/json",
                "Accept": "application/json, text/event-stream",
            };

            const body = {
                jsonrpc: "2.0",
                id: 3,
                method: "tools/call",
                params: {
                    name: "netlify-user-services-reader",
                    arguments: {
                        selectSchema: {
                            operation: "get-user",
                            params: {},
                        },
                    },
                },
            };

            fetch("https://netlify-mcp.netlify.app/mcp", {
                method: "POST",
                headers: headers,
                body: JSON.stringify(body),
            })
            .then(response => response.json())
            .then(data => {
                if (data.result && data.result.content) {
                    const userData = JSON.parse(data.result.content[0].text);
                    // Display user information
                    document.getElementById("user-info").textContent = JSON.stringify(userData, null, 2);
                } else {
                    document.getElementById("user-info").textContent = "Error: Could not fetch user data.";
                }
            })
            .catch(error => {
                document.getElementById("user-info").textContent = "Error: " + error;
            });
        }

        window.onload = function() {
            const authorizationCode = getAuthorizationCodeFromUrl();
            if (authorizationCode) {
                // Display the authorization code received from Netlify
                document.getElementById("authorization-code").textContent = "Authorization Code: " + authorizationCode;
                // Exchange the authorization code for access token
                getAccessToken(authorizationCode);
            }
        };
    </script>
</head>
<body>
    <h1>Login with Netlify</h1>
    <button onclick="loginWithNetlify()">Login</button>
    <p id="authorization-code"></p>
    <h2>User Information</h2>
    <pre id="user-info"></pre>
</body>
</html>
