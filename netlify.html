<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login with Netlify</title>
   <script>
function getUserInfo(accessToken) {
    const headers = {
        "Authorization": `Bearer ${accessToken}`,
        "Content-Type": "application/json",
        "Accept": "text/event-stream",
    };

    const body = {
        jsonrpc: "2.0",
        id: 3,
        method: "tools/call",
        params: {
            name: "netlify-user-services-reader",
            arguments: {
                selectSchema: {
                    operation: "get-user",
                    params: {},
                },
            },
        },
    };

    fetch("https://netlify-mcp.netlify.app/mcp", {
        method: "POST",
        headers,
        body: JSON.stringify(body),
    })
    .then(res => res.text())   // <-- IMPORTANT: read as raw text
    .then(raw => {
        // Extract only the JSON part after "data: "
        const match = raw.match(/data:\s*(.*)/);
        if (!match) {
            document.getElementById("user-info").textContent = "Error: Unable to extract JSON from SSE.";
            return;
        }

        let jsonText = match[1];

        // Remove outer quotes if present (because it's a JSON string inside a JSON string)
        if (jsonText.startsWith('"') && jsonText.endsWith('"')) {
            jsonText = jsonText.slice(1, -1);
        }

        // Remove escape characters
        jsonText = jsonText.replace(/\\"/g, '"');

        // Now parse into an object
        const parsed = JSON.parse(jsonText);

        // Display clean JSON (not beautified)
        document.getElementById("user-info").textContent = JSON.stringify(parsed);

    })
    .catch(error => {
        document.getElementById("user-info").textContent = "Error: " + error;
    });
}
</script>
</head>
<body>
    <h1>Login with Netlify</h1>
    <button onclick="loginWithNetlify()">Login</button>
    <p id="authorization-code"></p>
    <h2>User Information</h2>
    <pre id="user-info"></pre>
</body>
</html>
